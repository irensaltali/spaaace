{"version":3,"file":"MobileControls.js","names":["_eventemitter","require","_Utils","_interopRequireDefault","e","__esModule","_typeof","o","Symbol","iterator","constructor","prototype","_classCallCheck","a","n","TypeError","_defineProperties","r","t","length","enumerable","configurable","writable","Object","defineProperty","_toPropertyKey","key","_createClass","i","_toPrimitive","toPrimitive","call","String","Number","MobileControls","exports","clientEngine","_this","assign","EventEmitter","renderer","touchContainer","document","querySelector","setupListeners","activeInput","up","left","right","onRequestAnimationFrame","handleMovementInput","window","requestAnimationFrame","gameEngine","on","keyName","sendInput","value","_this2","touchHandler","touch","targetTouches","currentTouch","x","pageX","y","pageY","type","emit","addEventListener","playerShip","preventDefault","onKeyChange","isDown","playerShipScreenCoords","gameCoordsToScreen","dx","dy","shortestArc","Utils","Math","atan2","sin","actor","shipContainerSprite","rotation","PI","cos","rotateThreshold","distanceThreshold","sqrt"],"sources":["../../src/client/MobileControls.js"],"sourcesContent":["import { EventEmitter } from 'eventemitter3';\nimport Utils from '../common/Utils';\n\n/**\n * This class handles touch device controls\n */\nexport default class MobileControls {\n\n    constructor(clientEngine){\n        Object.assign(this, EventEmitter.prototype);\n        this.clientEngine = clientEngine;\n        this.renderer = clientEngine.renderer;\n\n        this.touchContainer = document.querySelector('.pixiContainer');\n        this.setupListeners();\n\n        this.activeInput = {\n            up: false,\n            left: false,\n            right: false\n        };\n\n        let onRequestAnimationFrame = () => {\n            this.handleMovementInput();\n            window.requestAnimationFrame(onRequestAnimationFrame);\n        };\n        onRequestAnimationFrame();\n\n        this.clientEngine.gameEngine.on('client__preStep', ()=>{\n            for (let keyName in this.activeInput){\n                if (this.activeInput[keyName]){\n                    this.clientEngine.sendInput(keyName);\n                }\n            }\n        });\n\n    }\n\n    setupListeners(){\n        let touchHandler = (e) => {\n            // If there's exactly one finger inside this element\n            let touch = e.targetTouches[0];\n            this.currentTouch = {\n                x: touch.pageX,\n                y: touch.pageY\n            };\n\n            if (e.type === 'touchstart' && e.targetTouches[1]){\n                this.emit('fire');\n            }\n        };\n\n        this.touchContainer.addEventListener('touchstart', touchHandler, false);\n        this.touchContainer.addEventListener('touchmove', (e) =>{\n            touchHandler(e);\n            // if ingame prevent scrolling\n            if (this.renderer.playerShip) {\n                e.preventDefault();\n            }\n        }, false);\n\n        this.touchContainer.addEventListener('touchend', (e) => {\n            this.currentTouch = false;\n            this.activeInput.up = false;\n            this.activeInput.left = false;\n            this.activeInput.right = false;\n            this.renderer.onKeyChange({ keyName: 'up', isDown: false });\n        }, false);\n\n        document.querySelector('.fireButton').addEventListener('click', () => {\n            this.emit('fire');\n        });\n    }\n\n    handleMovementInput(){\n        // no touch, no movement\n        if (!this.currentTouch) return;\n\n        // by default no touch\n        this.activeInput.right = false;\n        this.activeInput.left = false;\n        this.activeInput.up = false;\n\n        let playerShip = this.renderer.playerShip;\n        // no player ship, no movement\n        if (!playerShip) return;\n\n        let playerShipScreenCoords = this.renderer.gameCoordsToScreen(playerShip);\n\n        let dx = this.currentTouch.x - playerShipScreenCoords.x;\n        let dy = this.currentTouch.y - playerShipScreenCoords.y;\n        let shortestArc = Utils.shortestArc(Math.atan2(dx, -dy),\n            Math.atan2(Math.sin(playerShip.actor.shipContainerSprite.rotation + Math.PI / 2), Math.cos(playerShip.actor.shipContainerSprite.rotation + Math.PI / 2)));\n\n        let rotateThreshold = 0.3;\n        let distanceThreshold = 120;\n\n        // turn left or right\n        if (shortestArc > rotateThreshold){\n            this.activeInput.left = true;\n            this.activeInput.right = false;\n        } else if (shortestArc < -rotateThreshold) {\n            this.activeInput.right = true;\n            this.activeInput.left = false;\n        }\n\n        // don't turn if too close\n        if (Math.sqrt(dx * dx + dy * dy) > distanceThreshold) {\n            this.activeInput.up = true;\n            this.renderer.onKeyChange({ keyName: 'up', isDown: true });\n        } else {\n            this.renderer.onKeyChange({ keyName: 'up', isDown: false });\n        }\n\n    }\n\n}\n"],"mappings":"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","ignoreList":[]}